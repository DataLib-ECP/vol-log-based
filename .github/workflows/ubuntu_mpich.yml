name: Ubuntu_mpich

on:
  push:
    branches: [ master, dev ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'
  pull_request:
    branches: [ master, dev ]
    paths-ignore:
      - '**.md'
      - '**.txt'
      - 'docs/**'

jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v2
        - name: Set up dependencies
          run: |
            sudo apt-get update
            sudo apt-get install automake autoconf libtool libtool-bin m4
            # mpi
            sudo apt-get install mpich
            # zlib
            sudo apt-get install zlib1g-dev        
        - name: Install HDF5
          run: |
            WORKDIR=$(pwd)
            rm -rf hdf5-1.13.0.tar.gz hdf5-1.13.0 ${WORKDIR}/.local/hdf5/1.13.0
            wget -qc https://support.hdfgroup.org/ftp/HDF5/releases/hdf5-1.13/hdf5-1.13.0/src/hdf5-1.13.0.tar.gz
            tar -zxf hdf5-1.13.0.tar.gz
            cd hdf5-1.13.0
            ./configure --prefix=${WORKDIR}/.local/hdf5/1.13.0 --disable-fortran \
                        --disable-hl --disable-tests --disable-tools \
                        --enable-parallel --enable-build-mode=production CC=mpicc
            make -j 4 install
        - name: Test log VOL
          run: |
            WORKDIR=$(pwd)
            autoreconf -i
            ./configure --with-hdf5=${WORKDIR}/.local/hdf5/1.13.0 --enable-shared
            make -j 4 V=1
            make -j 4 V=1 tests
            make check
            make ptest
            make distcheck DISTCHECK_CONFIGURE_FLAGS="--with-hdf5=${WORKDIR}/.local/hdf5/1.13.0 --enable-shared"
        - name: Print log
          if: ${{ failure() }}
          run: |
            WORKDIR=$(pwd)
            cat ${WORKDIR}/config.log
            cat ${WORKDIR}/tests/dynamic/test-suite.log
            cat ${WORKDIR}/tests/nc4/test-suite.log
            cat ${WORKDIR}/tests/basic/test-suite.log
            cat ${WORKDIR}/tests/testcases/test-suite.log
            cat ${WORKDIR}/examples/hdf5_examples/test-suite.log

